<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THAI SINTO Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --accent: #D4AF37; --dark: #1a1a1a; --soft-bg: #f8f9fa; --text: #333; }
        body { font-family: 'Kanit', sans-serif; background: var(--soft-bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 400px; }
        
        /* Premium Member Card */
        .card-vip { 
            background: linear-gradient(135deg, #1a1a1a, #3a3a3a); color: white; 
            padding: 30px 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 1px solid var(--accent); position: relative; margin-bottom: 25px; overflow: hidden;
        }
        .card-vip img { position: absolute; right: 20px; bottom: 25px; width: 65px; height: 65px; border-radius: 50%; border: 2px solid var(--accent); background: #fff; }
        .card-label { color: var(--accent); font-size: 0.75rem; letter-spacing: 1.2px; font-weight: bold; }
        .card-name { font-size: 1.5rem; margin: 12px 0 5px; font-weight: bold; color: #fff; }
        .card-comp { font-size: 0.9rem; opacity: 0.8; color: #ddd; }
        
        /* UI Sections */
        .section { background: white; border-radius: 18px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h3 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--text); border-left: 4px solid var(--dark); padding-left: 12px; }
        
        label { font-size: 0.85rem; color: #888; margin-top: 10px; display: block; }
        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; font-family: 'Kanit'; font-size: 1rem; }
        input:focus, textarea:focus { outline: none; border-color: var(--accent); }
        
        button { width: 100%; padding: 16px; background: var(--dark); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; cursor: pointer; font-family: 'Kanit'; transition: 0.3s; font-size: 1rem; }
        button:active { transform: scale(0.98); }
        
        /* Log List */
        .history-item { border-bottom: 1px solid #f9f9f9; padding: 12px 0; }
        .history-item:last-child { border: none; }
        .h-date { color: #ccc; font-size: 0.7rem; margin-bottom: 3px; }
        .h-note { color: #666; font-size: 0.9rem; }
        
        .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div id="loading" class="loading">SYNCING DATA...</div>

<div class="container">
    <div class="card-vip">
        <div class="card-label">THAI SINTO SERVICES & MAINTENANCE</div>
        <div id="dispName" class="card-name">Guest Customer</div>
        <div id="dispCompany" class="card-comp">Company: -</div>
        <img id="userImg" src="https://via.placeholder.com/65">
    </div>

    <div class="section">
        <h3>Service Request / แจ้งบริการ</h3>
        
        <label>Full Name / ชื่อ-นามสกุล</label>
        <input type="text" id="fullName" placeholder="Enter your name">
        
        <label>Company / บริษัท</label>
        <input type="text" id="company" placeholder="Enter company name">
        
        <label>Phone / เบอร์โทร</label>
        <input type="tel" id="phone" placeholder="0XXXXXXXXX" maxlength="10">
        
        <label>Details / รายละเอียด</label>
        <textarea id="userNote" rows="3" placeholder="How can we help you?"></textarea>
        
        <button onclick="saveData()">SUBMIT REQUEST</button>
    </div>

    <div class="section">
        <h3>Activity Log / ประวัติ</h3>
        <div id="historyList">
            <div style="text-align:center; color:#ddd; padding:20px; font-size: 0.85rem;">No recent history</div>
        </div>
    </div>
</div>

<script>
    // --- ตั้งค่าข้อมูลตรงนี้ ---
    const LIFF_ID = "2008820291-s6WNZ5xr"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzjetrJkN9qYACPI8f1tCTgUlujx0MB72Q_Skn3BsieK2zeiauRVLOCSwVcTW73yn1wA/exec"; 

    async function main() {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            document.getElementById("userImg").src = profile.pictureUrl;
            loadData(profile.userId);
        }
    }

    async function loadData(userId) {
        document.getElementById("loading").style.display = "flex";
        try {
            const res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
            const data = await res.json();
            if (data.status === "found") {
                document.getElementById("dispName").innerText = data.user.fullName;
                document.getElementById("dispCompany").innerText = "Company: " + data.user.company;
                document.getElementById("fullName").value = data.user.fullName;
                document.getElementById("company").value = data.user.company;
                document.getElementById("phone").value = data.user.phone;
                
                const list = document.getElementById("historyList");
                list.innerHTML = data.history.map(h => `
                    <div class="history-item">
                        <div class="h-date">${h.date}</div>
                        <div class="h-note">${h.note}</div>
                    </div>
                `).join('');
            }
        } catch (e) { console.error(e); }
        document.getElementById("loading").style.display = "none";
    }

    async function saveData() {
        const name = document.getElementById("fullName").value;
        const comp = document.getElementById("company").value;
        const ph = document.getElementById("phone").value;
        const note = document.getElementById("userNote").value;

        if (!name || !ph || !note) return alert("Please fill in all fields.");

        document.getElementById("loading").style.display = "flex";
        const profile = await liff.getProfile();
        const payload = {
            userId: profile.userId, 
            lineName: profile.displayName,
            fullName: name, 
            company: comp || "-",
            phone: ph, 
            note: note
        };

        try {
            // 1. บันทึกข้อมูลลง Google Sheets
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
            
            // 2. ส่งแจ้งเตือนเข้าแชท LINE (แบบเรียบง่ายภาษาอังกฤษ)
            if (liff.isInClient()) {
                const now = new Date();
                const ts = `${now.toLocaleDateString('en-GB')} ${now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}`;
                
                await liff.sendMessages([{
                    "type": "text",
                    "text": `● SERVICE REQUEST\n—\nDetails\n${note}\n\nCustomer\n${name}\n${comp || '-'}\n${ph}\n—\n*${ts}*`
                }]);
            }
            alert("Request Sent Successfully!");
            location.reload();
        } catch (e) { 
            alert("Submission failed. Please try again."); 
        } finally {
            document.getElementById("loading").style.display = "none";
        }
    }

    main();
</script>
</body>
</html>
