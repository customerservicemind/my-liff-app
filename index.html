<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THAI SINTO SERVICES</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --main: #000000; --bg: #ffffff; --text: #000000; }
        body { font-family: 'Kanit', sans-serif; background: #f0f0f0; margin: 0; padding: 15px; color: var(--text); }
        .container { width: 100%; max-width: 420px; margin: 0 auto; }
        
        /* Premium Card */
        .card-vip { 
            background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%); 
            color: #ffffff; 
            padding: 40px 25px; border-radius: 25px; box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            position: relative; margin-bottom: 35px; text-align: left;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .card-label { font-size: 1.1rem; letter-spacing: 2px; font-weight: 700; color: #ffffff; border-bottom: 2px solid #fff; display: inline-block; margin-bottom: 15px; }
        .card-name { font-size: 2.2rem; font-weight: 700; margin: 10px 0 5px; text-transform: uppercase; color: #ffffff; text-shadow: 1px 1px 4px rgba(0,0,0,0.3); }
        .card-detail { font-size: 1.1rem; opacity: 1; margin-top: 5px; color: #ffffff; font-weight: 400; }
        
        #userImg { position: absolute; right: 20px; bottom: -20px; width: 110px; height: 110px; border-radius: 20px; border: 4px solid #fff; background: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.15); object-fit: cover; }

        /* Form */
        .section { background: white; border-radius: 25px; padding: 30px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h3 { margin: 0 0 20px 0; font-size: 1.6rem; font-weight: 700; text-transform: uppercase; border-left: 8px solid var(--main); padding-left: 15px; }
        
        label { font-size: 1.1rem; font-weight: 700; margin-top: 15px; display: block; text-transform: uppercase; }
        input, textarea, select { 
            width: 100%; padding: 16px; margin-top: 8px; border: 2px solid #eee; border-radius: 12px; 
            box-sizing: border-box; font-family: 'Kanit'; font-size: 1.1rem; background-color: white;
            appearance: none; -webkit-appearance: none; /* ลบสไตล์ดั้งเดิมของมือถือ */
        }
        
        /* สไตล์พิเศษสำหรับ Dropdown */
        select { 
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto;
            padding-right: 40px;
        }

        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--main); }
        
        .btn-submit { width: 100%; padding: 22px; background: var(--main); color: white; border: none; border-radius: 15px; font-weight: 700; margin-top: 30px; cursor: pointer; font-size: 1.4rem; text-transform: uppercase; transition: 0.3s; }
        .btn-submit:active { transform: scale(0.96); opacity: 0.8; }
        .btn-submit:disabled { background: #999; cursor: not-allowed; }

        /* History */
        .h-item { border-bottom: 2px solid #f0f0f0; padding: 15px 0; }
        .h-date { color: #999; font-size: 0.95rem; }
        .h-topic { font-weight: 700; font-size: 1.2rem; margin: 5px 0; color: var(--main); }
        .h-note { color: #444; font-size: 1.1rem; }

        .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: none; align-items: center; justify-content: center; z-index: 1000; font-weight: 700; font-size: 1.6rem; }
    </style>
</head>
<body>

<div id="loading" class="loading">SYNCING DATA...</div>

<div class="container">
    <div class="card-vip">
        <div class="card-label">THAI SINTO SERVICES</div>
        <div id="dispName" class="card-name">GUEST</div>
        <div id="dispCompany" class="card-detail">Company: -</div>
        <div id="dispEmail" class="card-detail">Email: -</div>
        <img id="userImg" src="https://via.placeholder.com/110">
    </div>

    <div class="section">
        <h3>Request / แจ้งบริการ</h3>
        
        <label>Subject / หัวข้อ</label>
        <select id="subject">
            <option value="" disabled selected>-- เลือกหัวข้อบริการ --</option>
            <option value="Machine Inquiry">Machine Inquiry สนใจสอบถามข้อมูลเครื่องจักร</option>
            <option value="Preventive Maintenance (PM) Check">Preventive Maintenance (PM) Check สอบถามตรวจเช็คสภาพเครื่องจักร</option>
            <option value="Maintenance Spare Parts Quotation">Maintenance Spare Parts Quotation สอบถามขอใบเสนอราคา</option>
        </select>
        
        <label>Full Name / ชื่อ-นามสกุล</label>
        <input type="text" id="fullName" placeholder="Your full name">
        
        <label>Company / บริษัท</label>
        <input type="text" id="company" placeholder="Company name">

        <label>Email / อีเมล</label>
        <input type="email" id="email" placeholder="example@email.com">
        
        <label>Phone / เบอร์โทร</label>
        <input type="tel" id="phone" placeholder="0XXXXXXXXX" maxlength="10">
        
        <label>Details / รายละเอียด</label>
        <textarea id="userNote" rows="3" placeholder="Explain your request..."></textarea>
        
        <button id="btnSave" class="btn-submit" onclick="saveData()">SUBMIT REQUEST</button>
    </div>

    <div class="section">
        <h3>Recent Activity / ประวัติ</h3>
        <div id="historyList"></div>
    </div>
</div>

<script>
    const LIFF_ID = "2009004913-zW1ZuaKw"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzu-fRvVOCgMndbI35FVoNsBARLHAdZ879miJBpx--Bc4BG9LUsfGrELKaB8pzo1uaW/exec"; 

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                document.getElementById("userImg").src = profile.pictureUrl;
                loadData(profile.userId);
            }
        } catch (e) { console.error(e); }
    }

    async function loadData(userId) {
        try {
            const res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
            const data = await res.json();
            if (data.status === "found") {
                document.getElementById("dispName").innerText = data.user.fullName.toUpperCase();
                document.getElementById("dispCompany").innerText = "Company: " + data.user.company;
                document.getElementById("dispEmail").innerText = "Email: " + data.user.email;
                
                document.getElementById("fullName").value = data.user.fullName;
                document.getElementById("company").value = data.user.company;
                document.getElementById("email").value = data.user.email;
                document.getElementById("phone").value = data.user.phone;
                
                document.getElementById("historyList").innerHTML = data.history.map(h => `
                    <div class="h-item">
                        <div class="h-date">${h.date}</div>
                        <div class="h-topic">${h.subject.toUpperCase()}</div>
                        <div class="h-note">${h.note || '-'}</div>
                    </div>
                `).join('');
            }
        } catch (e) { }
    }

    async function saveData() {
        const sub = document.getElementById("subject").value;
        const name = document.getElementById("fullName").value;
        const comp = document.getElementById("company").value;
        const email = document.getElementById("email").value;
        const ph = document.getElementById("phone").value;
        const note = document.getElementById("userNote").value;

        // การตรวจสอบข้อมูล
        if (!sub) return alert("กรุณาเลือก SUBJECT / หัวข้อ");
        if (!name || !email || !ph) return alert("กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน");

        document.getElementById("loading").style.display = "flex";
        document.getElementById("btnSave").disabled = true;

        try {
            const profile = await liff.getProfile();
            const payload = {
                userId: profile.userId, 
                lineName: profile.displayName,
                fullName: name, 
                company: comp || "-", 
                email: email, 
                phone: ph,
                subject: sub, 
                note: note
            };

            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });

            if (liff.isInClient()) {
                const ts = new Date().toLocaleString('en-GB');
                await liff.sendMessages([{
                    "type": "text",
                    "text": `● NEW SERVICE REQUEST\n—\nSubject: ${sub}\nDetails: ${note || '-'}\n\nCustomer: ${name}\nCompany: ${comp || '-'}\nEmail: ${email}\nPhone: ${ph}\n—\n*Recorded at ${ts}*`
                }]);
            }
            alert("SUCCESSFULLY SUBMITTED!");
            location.reload();
        } catch (e) { 
            alert("Error: Cannot connect to server."); 
        } finally {
            document.getElementById("loading").style.display = "none";
            document.getElementById("btnSave").disabled = false;
        }
    }

    window.onload = function() {
        main();
    };
</script>
</body>
</html>
