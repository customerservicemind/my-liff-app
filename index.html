<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --text: #333; --light-gray: #fdfdfd; --border: #eeeeee; --accent: #1a1a1a; }
        body { font-family: 'Kanit', sans-serif; background: #ffffff; color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; -webkit-font-smoothing: antialiased; }
        .container { width: 100%; max-width: 360px; }
        
        /* Member Card Design: Simple & Clean */
        .member-header { padding: 40px 0 20px 0; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .label { font-size: 0.65rem; letter-spacing: 3px; text-transform: uppercase; color: #aaaaaa; font-weight: 400; }
        .name { font-size: 1.8rem; font-weight: 400; margin: 8px 0; color: var(--accent); }
        .company { font-size: 0.9rem; color: #888888; }
        
        /* Form Design */
        .form-section { margin-top: 10px; }
        .input-group { margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid var(--border); font-family: 'Kanit'; font-size: 1rem; color: var(--text); background: transparent; transition: border-color 0.3s; }
        input:focus, textarea:focus { outline: none; border-bottom: 1px solid var(--accent); }
        textarea { resize: none; margin-top: 10px; }
        
        .btn-submit { width: 100%; padding: 18px; background: var(--accent); color: #ffffff; border: none; border-radius: 2px; font-size: 0.9rem; font-weight: 400; cursor: pointer; margin-top: 30px; letter-spacing: 2px; transition: opacity 0.3s; }
        .btn-submit:active { opacity: 0.8; }
        
        /* History Section */
        .history-section { margin-top: 50px; }
        .history-title { font-size: 0.7rem; color: #bbbbbb; letter-spacing: 2px; margin-bottom: 20px; }
        .history-item { padding: 15px 0; border-bottom: 1px solid #fafafa; }
        .h-date { font-size: 0.7rem; color: #cccccc; margin-bottom: 4px; }
        .h-note { font-size: 0.85rem; color: #666666; line-height: 1.5; }

        /* Loading */
        .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: none; align-items: center; justify-content: center; z-index: 100; font-size: 0.8rem; letter-spacing: 2px; color: #999; }
    </style>
</head>
<body>

<div id="loading" class="loading">SYNCING...</div>

<div class="container">
    <div class="member-header">
        <div class="label">Identity</div>
        <div id="dispName" class="name">Guest</div>
        <div id="dispCompany" class="company">Waiting for information...</div>
    </div>

    <div class="form-section">
        <input type="text" id="fullName" placeholder="Full Name">
        <input type="text" id="company" placeholder="Company / Organization">
        <input type="tel" id="phone" placeholder="Phone Number" maxlength="10">
        <textarea id="userNote" rows="2" placeholder="Note / Service Detail"></textarea>
        
        <button class="btn-submit" onclick="processRequest()">SAVE & REQUEST</button>
    </div>

    <div class="history-section">
        <div class="history-title">RECENT ACTIVITY</div>
        <div id="historyList">
            <div style="font-size: 0.8rem; color: #eee; padding: 10px 0;">No logs found</div>
        </div>
    </div>
</div>

<script>
    // --- ตั้งค่าข้อมูลของคุณตรงนี้ ---
    const LIFF_ID = "YOUR_LIFF_ID"; 
    const SCRIPT_URL = "YOUR_APPS_SCRIPT_URL"; 

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                fetchUserData(profile.userId);
            }
        } catch (e) { console.error(e); }
    }

    async function fetchUserData(userId) {
        try {
            const res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
            const data = await res.json();
            if (data.status === "found") {
                document.getElementById("dispName").innerText = data.user.fullName;
                document.getElementById("dispCompany").innerText = data.user.company || "-";
                document.getElementById("fullName").value = data.user.fullName;
                document.getElementById("company").value = data.user.company;
                document.getElementById("phone").value = data.user.phone;
                renderHistory(data.history);
            }
        } catch (e) { }
    }

    function renderHistory(history) {
        const list = document.getElementById("historyList");
        if (!history || history.length === 0) return;
        list.innerHTML = history.map(item => `
            <div class="history-item">
                <div class="h-date">${item.date}</div>
                <div class="h-note">${item.note}</div>
            </div>
        `).join('');
    }

    async function processRequest() {
        const name = document.getElementById("fullName").value;
        const comp = document.getElementById("company").value;
        const ph = document.getElementById("phone").value;
        const note = document.getElementById("userNote").value;

        if (!name || !ph || !note) return alert("Please fill in all fields.");

        document.getElementById("loading").style.display = "flex";
        const profile = await liff.getProfile();

        const payload = {
            userId: profile.userId,
            lineName: profile.displayName,
            fullName: name,
            company: comp,
            phone: ph,
            topic: "Service Request",
            note: note
        };

        try {
            // 1. บันทึกลง Google Sheets
            await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });

            // 2. ส่งแจ้งเตือนเข้า LINE (แบบเรียบ)
            if (liff.isInClient()) {
                const now = new Date();
                const timestamp = `${now.toLocaleDateString('en-GB')} ${now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}`;
                
                await liff.sendMessages([{
                    "type": "text",
                    "text": `● SERVICE REQUEST\n—\nDetails\n${note}\n\nCustomer\n${name}\n${comp || '-'}\n${ph}\n—\n*${timestamp}*`
                }]);
            }

            alert("Request successfully recorded.");
            location.reload(); // รีโหลดเพื่ออัปเดตหน้าจอ
        } catch (e) {
            alert("Connection error. Please try again.");
        } finally {
            document.getElementById("loading").style.display = "none";
        }
    }

    main();
</script>
</body>
</html>
