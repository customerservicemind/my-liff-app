<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Member Card</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; width: 100%; max-width: 360px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; margin-top: 10px; }
        .header { background: linear-gradient(135deg, #00b900 0%, #008f00 100%); color: white; padding: 25px; text-align: center; font-weight: bold; font-size: 1.3rem; }
        .profile-section { text-align: center; padding: 25px; background: #fff; }
        #pictureUrl { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #00b900; margin: 0 auto 15px; display: none; object-fit: cover; }
        .user-name { font-size: 1.2rem; font-weight: bold; color: #333; margin: 0; }
        .user-email { font-size: 0.85rem; color: #777; margin-top: 5px; }
        .form-section { padding: 20px 25px 30px; border-top: 1px solid #f0f0f0; }
        #statusMsg { font-size: 0.8rem; color: #00b900; background: #e8f5e9; padding: 8px; border-radius: 5px; margin-bottom: 15px; text-align: center; display: none; }
        label { display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; outline: none; }
        input:focus { border-color: #00b900; }
        button { width: 100%; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        .btn-save { background: #00b900; color: white; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,185,0,0.2); }
        .btn-save:hover { background: #009900; }
        .btn-close { background: #fff; color: #888; border: 1px solid #ddd; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="loader" class="loading-overlay">
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
    </div>

    <div class="card">
        <div class="header">DIGITAL MEMBER CARD</div>
        
        <div class="profile-section">
            <img id="pictureUrl" src="" alt="Profile">
            <div id="displayName" class="user-name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <div id="displayEmail" class="user-email">...</div>
        </div>

        <div class="form-section">
            <div id="statusMsg">‚ú® ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πà‡∏≤ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            
            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</label>
            <input type="tel" id="phone" placeholder="08XXXXXXXX" maxlength="10">
            
            <button id="saveBtn" class="btn-save" onclick="saveData()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            <button class="btn-close" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script>
        // --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏≠‡∏î‡∏µ‡∏ï‡πà‡∏≤‡∏á‡πÜ ---
        const LIFF_ID = "2008820291-s6WNZ5xr"; 
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzbhX_8ONEombjKrRMTHB7mlR6WiytUV08WYODc5PGARcAOU3Y85KMLIZJ4N_jaETmTA/exec"; 

        let userEmail = ""; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡∏•‡∏≤‡∏á

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    loadProfile();
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF Init Error:", err);
            }
        }

        async function loadProfile() {
            const profile = await liff.getProfile();
            
            // ‡∏î‡∏∂‡∏á Email ‡∏à‡∏≤‡∏Å ID Token (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Scopes ‡πÉ‡∏ô LINE Console ‡∏Å‡πà‡∏≠‡∏ô)
            const idToken = liff.getDecodedIDToken();
            userEmail = idToken ? idToken.email : "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•";

            document.getElementById("displayName").innerText = profile.displayName;
            document.getElementById("displayEmail").innerText = userEmail;

            if (profile.pictureUrl) {
                document.getElementById("pictureUrl").src = profile.pictureUrl;
                document.getElementById("pictureUrl").style.display = "block";
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A (UserID) ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            checkExistingUser(profile.userId);
        }

        function checkExistingUser(userId) {
            fetch(`${SCRIPT_URL}?userId=${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "found") {
                        document.getElementById("phone").value = data.phone;
                        document.getElementById("saveBtn").innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                        document.getElementById("statusMsg").style.display = "block";
                    }
                })
                .catch(err => console.log("User ‡πÉ‡∏´‡∏°‡πà"));
        }

        async function saveData() {
            const phone = document.getElementById("phone").value;
            if (phone.length < 10) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 ‡∏´‡∏•‡∏±‡∏Å");
                return;
            }

            document.getElementById("loader").style.display = "flex";
            const profile = await liff.getProfile();

            const payload = {
                userId: profile.userId,
                name: profile.displayName,
                phone: phone,
                email: userEmail // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                body: JSON.stringify(payload)
            }).then(() => {
                if (liff.isInClient()) {
                    liff.sendMessages([{
                        type: 'text',
                        text: `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\nüë§ ‡∏Ñ‡∏∏‡∏ì: ${profile.displayName}\nüìß: ${userEmail}\nüìû: ${phone}`
                    }]);
                }
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                liff.closeWindow();
            }).catch(err => {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
                document.getElementById("loader").style.display = "none";
            });
        }

        main();
    </script>
</body>
</html>
